#!/bin/bash

# Mads' Strap After Setup Script
# Runs after the main bootstrap process to finalize configuration

set -e

echo ""
echo "ðŸ”§ Running final configuration steps..."
echo ""

# Apply macOS defaults
if [ -x "script/macos-defaults" ]; then
  echo "â†’ Applying macOS system preferences..."
  ./script/macos-defaults
fi

# Set zsh as default shell if it isn't already
if [ "$SHELL" != "$(which zsh)" ]; then
  echo "â†’ Setting zsh as default shell..."
  sudo chsh -s $(which zsh) $USER
fi

# Configure Cursor if it's installed
if command -v cursor >/dev/null 2>&1; then
  echo "â†’ Setting up Cursor with essential extensions..."
  
  # Icon theme
  cursor --install-extension PKief.material-icon-theme
  
  # Code formatting & quality
  cursor --install-extension esbenp.prettier-vscode
  
  # Web development
  cursor --install-extension bradlc.vscode-tailwindcss
  cursor --install-extension astro-build.astro-vscode
  cursor --install-extension formulahendry.auto-rename-tag
  cursor --install-extension christian-kohler.path-intellisense
  cursor --install-extension britesnow.vscode-toggle-quotes
  
  # GitHub integration
  cursor --install-extension github.vscode-pull-request-github
  
  echo "â†’ Cursor configured with essential extensions"
fi

# Generate SSH key if none exists
if [ ! -f "$HOME/.ssh/id_ed25519" ]; then
  echo "â†’ Generating SSH key..."
  ssh-keygen -t ed25519 -C "mads@madsfors.dk" -f "$HOME/.ssh/id_ed25519" -N ""
  
  echo ""
  echo "ðŸ“‹ Your SSH public key (copy this to GitHub):"
  echo ""
  cat "$HOME/.ssh/id_ed25519.pub"
  echo ""
  echo "Add this to your GitHub account: https://github.com/settings/ssh/new"
  echo ""
fi

# Start SSH agent and add key
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519 2>/dev/null || true

# Setup git configuration
echo "â†’ Setting up git..."
git config --global user.name "Mads Fors"
git config --global user.email "mads@madsfors.dk"
git config --global github.user "madsfors"
git config --global init.defaultBranch main
git config --global push.autoSetupRemote true
git config --global pull.rebase true

echo ""
echo "ðŸŽ‰ Final configuration complete!"
echo ""
echo "Manual steps you may want to complete:"
echo "â€¢ Add your SSH key to GitHub (shown above)"
echo "â€¢ Sign in to all your applications"
echo "â€¢ Configure 1Password browser integration"
echo "â€¢ Set up any remaining app-specific preferences"
echo ""